# Secure CI/CD Pipeline for Loni Panchayat Tax Collection System
# Following OWASP Top 10 Security Practices
# https://owasp.org/www-project-top-ten/

name: Secure CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run security scans weekly on Sunday at midnight
    - cron: '0 0 * * 0'

env:
  NODE_VERSION: '18'
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

# Restrict permissions following principle of least privilege
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================
  # JOB 1: Dependency Security Audit
  # OWASP A06:2021 - Vulnerable and Outdated Components
  # ============================================
  dependency-audit:
    name: ðŸ” Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Run npm audit (JSON output for artifacts)
        run: npm audit --json > npm-audit-report.json || true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30

  # ============================================
  # JOB 2: Static Application Security Testing (SAST)
  # OWASP A03:2021 - Injection
  # OWASP A07:2021 - Identification and Authentication Failures
  # ============================================
  sast-scan:
    name: ðŸ›¡ï¸ SAST Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # ============================================
  # JOB 3: Secret Detection
  # OWASP A02:2021 - Cryptographic Failures
  # ============================================
  secret-scan:
    name: ðŸ” Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # JOB 4: Linting & Code Quality
  # OWASP A04:2021 - Insecure Design
  # ============================================
  lint-and-quality:
    name: ðŸ“ Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with security rules
        run: npm run lint -- --max-warnings 0
        continue-on-error: true

      - name: TypeScript type checking
        run: npx tsc --noEmit

  # ============================================
  # JOB 5: Security Headers & Configuration Check
  # OWASP A05:2021 - Security Misconfiguration
  # ============================================
  security-config-check:
    name: âš™ï¸ Security Configuration Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for security headers in next.config
        run: |
          echo "Checking security headers configuration..."
          if grep -q "X-Content-Type-Options" next.config.ts; then
            echo "âœ… X-Content-Type-Options header found"
          else
            echo "âš ï¸ Missing X-Content-Type-Options header"
          fi
          if grep -q "X-Frame-Options" next.config.ts; then
            echo "âœ… X-Frame-Options header found"
          else
            echo "âš ï¸ Missing X-Frame-Options header"
          fi
          if grep -q "Content-Security-Policy" next.config.ts; then
            echo "âœ… Content-Security-Policy header found"
          else
            echo "âš ï¸ Missing Content-Security-Policy header"
          fi

      - name: Check Firestore security rules
        run: |
          echo "Checking Firestore security rules..."
          if grep -q "isSignedIn()" firestore.rules; then
            echo "âœ… Authentication checks present in Firestore rules"
          else
            echo "âŒ Missing authentication checks in Firestore rules"
            exit 1
          fi
          if grep -q "request.auth != null" firestore.rules; then
            echo "âœ… Auth null checks present"
          else
            echo "âš ï¸ Consider adding explicit auth null checks"
          fi

      - name: Check for exposed secrets in code
        run: |
          echo "Scanning for potential exposed secrets..."
          # Check for common secret patterns
          if grep -rE "(api[_-]?key|apikey|secret|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.tsx" --include="*.js" src/ 2>/dev/null | grep -v "process.env" | grep -v ".example"; then
            echo "âš ï¸ Potential hardcoded secrets detected (review manually)"
          else
            echo "âœ… No obvious hardcoded secrets found"
          fi

  # ============================================
  # JOB 6: Build & Test
  # ============================================
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: [dependency-audit, lint-and-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: out/
          retention-days: 7

  # ============================================
  # JOB 7: OWASP ZAP Dynamic Security Scan
  # OWASP A01:2021 - Broken Access Control
  # OWASP A03:2021 - Injection
  # ============================================
  dast-scan:
    name: ðŸŒ DAST Security Scan
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: out/

      - name: Start local server for testing
        run: |
          npx serve out -l 3000 &
          sleep 5

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-report
          path: report_html.html
          retention-days: 30

  # ============================================
  # JOB 8: Container Security (if using Docker)
  # OWASP A06:2021 - Vulnerable and Outdated Components
  # ============================================
  container-scan:
    name: ðŸ³ Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: dockerfile-check
        run: |
          if [ -f "Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        if: steps.dockerfile-check.outputs.exists == 'true'
        run: docker build -t loni-panchayat:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'loni-panchayat:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # JOB 9: Infrastructure as Code Security
  # OWASP A05:2021 - Security Misconfiguration
  # ============================================
  iac-security:
    name: ðŸ“‹ IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov for IaC security
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: all
          output_format: cli
          soft_fail: true

  # ============================================
  # JOB 10: Deploy to Firebase (Production)
  # With Security Gates
  # ============================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [sast-scan, secret-scan, security-config-check, build-and-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://studio-7943908738-8bbf8.web.app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: out/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy Firestore Rules
        run: |
          npm install -g firebase-tools
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > service-account.json
          export GOOGLE_APPLICATION_CREDENTIALS=service-account.json
          firebase deploy --only firestore:rules --project ${{ secrets.FIREBASE_PROJECT_ID }}
          rm service-account.json

  # ============================================
  # JOB 11: Post-Deployment Security Verification
  # ============================================
  post-deploy-verify:
    name: âœ… Post-Deploy Security Check
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Verify security headers
        run: |
          echo "Checking security headers on production..."
          HEADERS=$(curl -sI https://studio-7943908738-8bbf8.web.app)
          echo "$HEADERS"
          
          if echo "$HEADERS" | grep -qi "x-frame-options"; then
            echo "âœ… X-Frame-Options present"
          else
            echo "âš ï¸ X-Frame-Options missing"
          fi

      - name: Check SSL/TLS configuration
        run: |
          echo "Checking SSL configuration..."
          curl -sI https://studio-7943908738-8bbf8.web.app | head -1
          echo "âœ… HTTPS is working"

      - name: Verify no sensitive data exposed
        run: |
          echo "Checking for exposed sensitive endpoints..."
          # Check that common sensitive paths return 404 or are protected
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://studio-7943908738-8bbf8.web.app/.env)
          if [ "$STATUS" = "404" ]; then
            echo "âœ… .env file not exposed"
          else
            echo "âš ï¸ Check .env file exposure"
          fi

  # ============================================
  # JOB 12: Security Report Generation
  # ============================================
  security-report:
    name: ðŸ“Š Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-audit, sast-scan, secret-scan, security-config-check]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" > security-report.md
          echo "Date: $(date)" >> security-report.md
          echo "Commit: ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Scan Results" >> security-report.md
          echo "- Dependency Audit: âœ… Complete" >> security-report.md
          echo "- SAST Scan: âœ… Complete" >> security-report.md
          echo "- Secret Detection: âœ… Complete" >> security-report.md
          echo "- Security Config Check: âœ… Complete" >> security-report.md
          echo "" >> security-report.md
          echo "## OWASP Top 10 Coverage" >> security-report.md
          echo "- A01:2021 Broken Access Control: âœ… Firestore rules checked" >> security-report.md
          echo "- A02:2021 Cryptographic Failures: âœ… Secret scanning enabled" >> security-report.md
          echo "- A03:2021 Injection: âœ… SAST/CodeQL scanning" >> security-report.md
          echo "- A04:2021 Insecure Design: âœ… Code quality checks" >> security-report.md
          echo "- A05:2021 Security Misconfiguration: âœ… Config checks enabled" >> security-report.md
          echo "- A06:2021 Vulnerable Components: âœ… Dependency audit" >> security-report.md
          echo "- A07:2021 Auth Failures: âœ… Auth code review via SAST" >> security-report.md
          echo "- A08:2021 Software/Data Integrity: âœ… Build verification" >> security-report.md
          echo "- A09:2021 Logging Failures: âš ï¸ Manual review recommended" >> security-report.md
          echo "- A10:2021 SSRF: âœ… SAST scanning" >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 90
