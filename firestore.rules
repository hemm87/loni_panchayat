/**
 * @fileOverview Firestore Security Rules for the Loni Panchayat Tax Management System.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Users can only access their own profile data,
 * properties, tax records, and payments. Administrative roles are managed via the `role` field in the user document.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.  `userId` MUST match the authenticated user's UID.
 * - /users/{userId}/properties/{propertyId}: Stores property records owned by the user.
 * - /users/{userId}/taxRecords/{taxRecordId}: Stores tax records related to a user's property.
 * - /users/{userId}/payments/{paymentId}: Stores payment records made by a user for their tax records.
 *
 * Key Security Decisions:
 * - Users can only read and write their own data. No cross-user data access is allowed except for potential admin roles (currently not implemented).
 * - Data consistency is enforced by validating the `userId` in the path against the authenticated user's UID.
 * - List operations are restricted to the owner of the data.
 * - Anonymous users can be created and have their own data, but it is subject to the same ownership restrictions.
 *
 * Denormalization for Authorization:
 * - User ownership is enforced through path-based rules, eliminating the need for data denormalization or `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the authenticated user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user_abc' can create their profile if request.auth.uid == 'user_abc'.
     * @allow (get, update, delete) - User with UID 'user_abc' can read/write their profile if request.auth.uid == 'user_abc'.
     * @deny (create, get, update, delete) - User with UID 'user_xyz' cannot access profile of user with UID 'user_abc'.
     * @principle Enforces strict user ownership for profile data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Self-creation: Allow a user to create their own profile if the UID matches.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;

      // Allow read, update, and delete only if the user is signed in and is the owner.
      allow get, update, delete: if isSignedIn() && isOwner(userId) && resource.data.id == userId;

      // No listing of users.
      allow list: if false;
    }

    /**
     * @description Secure property records. Only the owner can read/write their properties.
     * @path /users/{userId}/properties/{propertyId}
     * @allow (create) - User with UID 'user_abc' can create a property under /users/user_abc/properties if request.auth.uid == 'user_abc'.
     * @allow (get, list, update, delete) - User with UID 'user_abc' can read/write their property under /users/user_abc/properties if request.auth.uid == 'user_abc'.
     * @deny (create, get, list, update, delete) - User with UID 'user_xyz' cannot access properties under /users/user_abc/properties.
     * @principle Enforces user ownership for property records.
     */
    match /users/{userId}/properties/{propertyId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow creation only if the user is signed in and is the owner.
      allow create: if isSignedIn() && isOwner(userId);

      // Allow read, update, and delete only if the user is signed in and is the owner.
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secure tax records. Only the owner can read/write their tax records.
     * @path /users/{userId}/taxRecords/{taxRecordId}
     * @allow (create) - User with UID 'user_abc' can create a tax record under /users/user_abc/taxRecords if request.auth.uid == 'user_abc'.
     * @allow (get, list, update, delete) - User with UID 'user_abc' can read/write their tax record under /users/user_abc/taxRecords if request.auth.uid == 'user_abc'.
     * @deny (create, get, list, update, delete) - User with UID 'user_xyz' cannot access tax records under /users/user_abc/taxRecords.
     * @principle Enforces user ownership for tax records.
     */
    match /users/{userId}/taxRecords/{taxRecordId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }


      // Allow creation only if the user is signed in and is the owner.
      allow create: if isSignedIn() && isOwner(userId);

      // Allow read, update, and delete only if the user is signed in and is the owner.
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secure payment records. Only the owner can read/write their payment records.
     * @path /users/{userId}/payments/{paymentId}
     * @allow (create) - User with UID 'user_abc' can create a payment under /users/user_abc/payments if request.auth.uid == 'user_abc'.
     * @allow (get, list, update, delete) - User with UID 'user_abc' can read/write their payment under /users/user_abc/payments if request.auth.uid == 'user_abc'.
     * @deny (create, get, list, update, delete) - User with UID 'user_xyz' cannot access payments under /users/user_abc/payments.
     * @principle Enforces user ownership for payment records.
     */
    match /users/{userId}/payments/{paymentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }


      // Allow creation only if the user is signed in and is the owner.
      allow create: if isSignedIn() && isOwner(userId);

      // Allow read, update, and delete only if the user is signed in and is the owner.
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }
}