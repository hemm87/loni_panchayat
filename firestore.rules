rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects the /users/{userId} collection, ensuring only the authenticated user can manage their own profile.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile. (auth.uid: 'user123', request.resource.data.id: 'user123')
     * @allow (get, update, delete) - Authenticated user reads/updates/deletes their own profile. (auth.uid: 'user123', userId: 'user123')
     * @deny (create) - Authenticated user tries to create a profile with a different ID. (auth.uid: 'user123', request.resource.data.id: 'otherUser')
     * @deny (get, update, delete) - Authenticated user tries to read/update/delete someone else's profile. (auth.uid: 'user123', userId: 'otherUser')
     * @principle Enforces document ownership, validates user ID on create.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects the /users/{userId}/taxYears/{taxYearId} collection, ensuring only the owner can manage their tax years.
     * @path /users/{userId}/taxYears/{taxYearId}
     * @allow (create) - Authenticated user creates a tax year under their profile. (auth.uid: 'user123', userId: 'user123')
     * @allow (get, list, update, delete) - Authenticated user reads/lists/updates/deletes their tax years. (auth.uid: 'user123', userId: 'user123')
     * @deny (create) - Authenticated user tries to create a tax year under someone else's profile. (auth.uid: 'user123', userId: 'otherUser')
     * @deny (get, list, update, delete) - Authenticated user tries to read/list/update/delete someone else's tax years. (auth.uid: 'user123', userId: 'otherUser')
     * @principle Enforces document ownership for tax years.
     */
    match /users/{userId}/taxYears/{taxYearId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects the /users/{userId}/taxYears/{taxYearId}/incomes/{incomeId} collection, ensuring only the owner can manage their income records.
     * @path /users/{userId}/taxYears/{taxYearId}/incomes/{incomeId}
     * @allow (create) - Authenticated user creates an income record under their tax year. (auth.uid: 'user123', userId: 'user123')
     * @allow (get, list, update, delete) - Authenticated user reads/lists/updates/deletes their income records. (auth.uid: 'user123', userId: 'user123')
     * @deny (create) - Authenticated user tries to create an income record under someone else's tax year. (auth.uid: 'user123', userId: 'otherUser')
     * @deny (get, list, update, delete) - Authenticated user tries to read/list/update/delete someone else's income records. (auth.uid: 'user123', userId: 'otherUser')
     * @principle Enforces document ownership for income records.
     */
    match /users/{userId}/taxYears/{taxYearId}/incomes/{incomeId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects the /users/{userId}/taxYears/{taxYearId}/expenses/{expenseId} collection, ensuring only the owner can manage their expense records.
     * @path /users/{userId}/taxYears/{taxYearId}/expenses/{expenseId}
     * @allow (create) - Authenticated user creates an expense record under their tax year. (auth.uid: 'user123', userId: 'user123')
     * @allow (get, list, update, delete) - Authenticated user reads/lists/updates/deletes their expense records. (auth.uid: 'user123', userId: 'user123')
     * @deny (create) - Authenticated user tries to create an expense record under someone else's tax year. (auth.uid: 'user123', userId: 'otherUser')
     * @deny (get, list, update, delete) - Authenticated user tries to read/list/update/delete someone else's expense records. (auth.uid: 'user123', userId: 'otherUser')
     * @principle Enforces document ownership for expense records.
     */
    match /users/{userId}/taxYears/{taxYearId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects the /users/{userId}/documents/{documentId} collection, ensuring only the owner can manage their documents.
     * @path /users/{userId}/documents/{documentId}
     * @allow (create) - Authenticated user creates a document under their profile. (auth.uid: 'user123', userId: 'user123')
     * @allow (get, list, update, delete) - Authenticated user reads/lists/updates/deletes their documents. (auth.uid: 'user123', userId: 'user123')
     * @deny (create) - Authenticated user tries to create a document under someone else's profile. (auth.uid: 'user123', userId: 'otherUser')
     * @deny (get, list, update, delete) - Authenticated user tries to read/list/update/delete someone else's documents. (auth.uid: 'user123', userId: 'otherUser')
     * @principle Enforces document ownership for documents.
     */
    match /users/{userId}/documents/{documentId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
  }
}