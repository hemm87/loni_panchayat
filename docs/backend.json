
{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user within the Loni Panchayat Tax Management System.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "User's display name."
        },
        "role": {
          "type": "string",
          "description": "User's role.",
          "enum": ["admin", "operator", "viewer", "citizen"]
        }
      },
      "required": [
        "id",
        "email",
        "displayName",
        "role"
      ]
    },
    "Property": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Property",
      "type": "object",
      "description": "Represents a property registered in the Loni Panchayat Tax Management System.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Property entity."
        },
        "ownerId": {
          "type": "string",
          "description": "Reference to User (owner). (Relationship: User 1:N Property)"
        },
        "houseNumber": {
          "type": "string",
          "description": "House number of the property."
        },
        "propertyType": {
          "type": "string",
          "description": "Type of property (Residential/Commercial/Agricultural)."
        },
        "area": {
          "type": "number",
          "description": "Area of the property in sq.ft or acres."
        },
        "propertyPhotos": {
          "type": "array",
          "description": "Url of property photo proof.",
          "items": {
            "type": "string"
          }
        },
        "aadhaarNumber": {
          "type": "string",
          "description": "Aadhaar number of the owner (encrypted)."
        }
      },
      "required": [
        "id",
        "ownerId",
        "houseNumber",
        "propertyType",
        "area"
      ]
    },
    "TaxRecord": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TaxRecord",
      "type": "object",
      "description": "Represents a tax record for a property in the Loni Panchayat Tax Management System.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TaxRecord entity."
        },
        "propertyId": {
          "type": "string",
          "description": "Reference to Property. (Relationship: Property 1:N TaxRecord)"
        },
        "assessmentYear": {
          "type": "number",
          "description": "Year for which the tax is assessed."
        },
        "taxType": {
          "type": "string",
          "description": "Type of tax (e.g., House Tax, Land Tax)."
        },
        "assessedAmount": {
          "type": "number",
          "description": "Amount of tax assessed."
        },
        "amountDue": {
          "type": "number",
          "description": "Amount of tax still due."
        },
        "amountPaid": {
          "type": "number",
          "description": "Amount of tax paid."
        },
        "paymentStatus": {
          "type": "string",
          "description": "Payment status (Paid/Unpaid/Partial)."
        },
        "paymentDate": {
          "type": "string",
          "description": "Date of payment.",
          "format": "date-time"
        },
        "receiptNumber": {
          "type": "string",
          "description": "Receipt number for the payment."
        }
      },
      "required": [
        "id",
        "propertyId",
        "assessmentYear",
        "taxType",
        "assessedAmount",
        "amountDue",
        "amountPaid",
        "paymentStatus"
      ]
    },
    "Payment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Payment",
      "type": "object",
      "description": "Represents a payment made for a tax record.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Payment entity."
        },
        "taxRecordId": {
          "type": "string",
          "description": "Reference to TaxRecord. (Relationship: TaxRecord 1:N Payment)"
        },
        "amount": {
          "type": "number",
          "description": "Amount paid in this payment."
        },
        "paymentDate": {
          "type": "string",
          "description": "Date of the payment.",
          "format": "date-time"
        },
        "paymentMode": {
          "type": "string",
          "description": "Payment mode (Cash/UPI/Card/Bank)."
        },
        "receiptNumber": {
          "type": "string",
          "description": "Receipt number for the payment."
        },
        "receiptImageURL": {
          "type": "string",
          "description": "URL of the uploaded receipt image."
        }
      },
      "required": [
        "id",
        "taxRecordId",
        "amount",
        "paymentDate",
        "paymentMode"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. The `userId` parameter matches the Firebase Auth UID.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/properties/{propertyId}",
        "definition": {
          "entityName": "Property",
          "schema": {
            "$ref": "#/backend/entities/Property"
          },
          "description": "Stores property records for a specific user. The `userId` parameter ensures ownership.  ownerId field reinforces ownership",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user who owns the property."
            },
            {
              "name": "propertyId",
              "description": "The unique ID of the property."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/taxRecords/{taxRecordId}",
        "definition": {
          "entityName": "TaxRecord",
          "schema": {
            "$ref": "#/backend/entities/TaxRecord"
          },
          "description": "Stores tax records associated with a user's property.  Path based ownership from users collection.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user who owns the property and the tax record."
            },
            {
              "name": "taxRecordId",
              "description": "The unique ID of the tax record."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/payments/{paymentId}",
        "definition": {
          "entityName": "Payment",
          "schema": {
            "$ref": "#/backend/entities/Payment"
          },
          "description": "Stores payment records for tax records, associated with properties owned by users. Path based ownership from users collection",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user who made the payment."
            },
            {
              "name": "paymentId",
              "description": "The unique ID of the payment."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide a secure, scalable, and easily maintainable database for the Loni Panchayat Tax Management System. It follows the principles of Authorization Independence, Structural Segregation, and Access Modeling to ensure robust security rules and efficient data access.\n\n**Authorization Independence:**\nAuthorization Independence is achieved through path-based ownership. User-owned data (Properties, TaxRecords, and Payments) are nested under the `/users/{userId}` collection. This structure allows security rules to be written based solely on the `request.auth.uid` and the path, avoiding the need for costly and brittle `get()` calls to parent documents. No denormalization is needed due to path-based ownership, further simplifying security rules and ensuring atomicity of operations.\n\n**Structural Segregation:**\nThe system segregates data based on its security posture. User profiles are stored in `/users/{userId}`, ensuring that only the authenticated user can access their data. Properties, Tax Records, and Payments associated with a user are stored under their respective user ID path, maintaining clear ownership. There's no need to mix public and private data within the same collections.\n\n**Access Modeling:**\nThe system uses path-based ownership for private user data. The `/users/{userId}` collection stores user profiles, and subsequent collections like `/users/{userId}/properties/{propertyId}`, `/users/{userId}/taxRecords/{taxRecordId}`, and `/users/{userId}/payments/{paymentId}` inherit ownership through the path. This is the most secure and efficient way to model user-owned data in Firestore. Global roles (admin, operator, viewer) are managed through content stored in the User document `users/{userId}`.\n\n**QAPs (Rules are not Filters):**\nThis structure enables secure `list` operations.  Because ownership is embedded in the path, rules can efficiently filter lists to only return resources owned by the requesting user or based on user role, without requiring filtering logic in the rules themselves. For example, listing properties can be secured with a simple rule `allow list: if request.auth.uid == userId;`.\n\n**Invariants:**\nThe structure supports the integrity of ownership. The `ownerId` field in the `/properties` collection reinforces path-based ownership. Timestamps (if needed) can be added at each level. Denormalized data (if required in future, though not currently) can be efficiently managed without breaking authorization independence, since ownership doesn't rely on it."
  }
}
